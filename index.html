<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Spotify PKCE Playlist Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      button { padding: 10px 14px; margin: 6px 6px 6px 0; cursor: pointer; }
      code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
      .row { display: flex; gap: 24px; flex-wrap: wrap; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; min-width: 320px; }
      ul { padding-left: 18px; }
      small { color: #555; }
      pre { background: #0b1020; color: #e6e6e6; padding: 12px; border-radius: 12px; overflow: auto; }
      input { padding: 8px; width: 420px; max-width: 100%; }
    </style>
  </head>

  <body>
    <h1>üéµ YouTube Music Playlist Viewer</h1>

    <div class="card">
      <label for="playlistLink" style="display: block; margin-bottom: 8px; font-weight: bold;">
        Paste a YouTube Music Playlist Link:
      </label>
      <input 
        id="playlistLink" 
        type="text" 
        placeholder="https://music.youtube.com/playlist?list=..." 
        style="width: 100%; max-width: none;"
      />
      <div style="margin-top: 12px;">
        <button id="fetchBtn" style="
          background: #FF0000;
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 500px;
          font-weight: bold;
          cursor: pointer;
          font-size: 14px;
          transition: background 0.2s;
        " onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#FF0000'">
          üîç Load Playlist
        </button>
      </div>
      <div style="margin-top: 12px;">
        <small id="status" style="color: #666;">Ready to load a playlist</small>
      </div>
    </div>

    <div class="card" style="margin-top: 18px;">
      <h2>Playlist Info</h2>
      <div id="playlistInfo"></div>
    </div>

    <div class="card" style="margin-top: 18px;">
      <h2>Tracks</h2>
      <div id="tracksList"></div>
    </div>

    <script type="module">
      const $ = (id) => document.getElementById(id);

      function extractPlaylistId(url) {
        const match = url.match(/list=([a-zA-Z0-9_-]+)/);
        return match ? match[1] : null;
      }

      function setStatus(msg) {
        $("status").textContent = msg;
      }

      let currentAudio = null;

      function playPreview(url, btn) {
        if (!url) return;
        if (currentAudio && !currentAudio.paused) {
          currentAudio.pause();
          const prevBtn = document.querySelector('.playing');
          if (prevBtn) prevBtn.classList.remove('playing');
        }

        if (currentAudio && currentAudio.src === url && currentAudio.paused) {
          currentAudio.play();
          if (btn) btn.classList.add('playing');
          return;
        }

        if (currentAudio) {
          currentAudio.pause();
        }

        currentAudio = new Audio(url);
        currentAudio.play().catch(() => {});
        if (btn) btn.classList.add('playing');

        currentAudio.onended = () => {
          if (btn) btn.classList.remove('playing');
        };
      }

      $("fetchBtn").onclick = async () => {
        const link = $("playlistLink").value.trim();
        if (!link) {
          setStatus("‚ùå Paste a YouTube Music playlist link");
          return;
        }

        const playlistId = extractPlaylistId(link);
        if (!playlistId) {
          setStatus("‚ùå Invalid YouTube Music playlist link");
          return;
        }

        try {
          setStatus("‚è≥ Looking up previews (this may take a moment)...");
          const resp = await fetch(`/api/playlist/${playlistId}/deezer-previews`);
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || `Error: ${resp.status}`);
          }

          const data = await resp.json();

          // Playlist info
          $("playlistInfo").innerHTML = `
            <div><b>${data.playlist.name}</b></div>
            <div><small>${data.playlist.totalTracks} tracks</small></div>
          `;

          if (!data.tracks || data.tracks.length === 0) {
            $("tracksList").innerHTML = "<div>No tracks found</div>";
            setStatus('‚úÖ No tracks');
            return;
          }

          // Build track list with preview buttons
          const trackHTML = data.tracks.map((t, i) => {
            const previewUrl = t.deezer?.preview ? `/api/preview-proxy?url=${encodeURIComponent(t.deezer.preview)}` : null;
            const playBtn = previewUrl ? `<button class="play-btn" data-preview="${previewUrl}">‚ñ∂ Play 30s</button>` : `<small style="color:#999">No preview</small>`;
            return `
              <div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:12px; align-items:center;">
                <div style="flex:1">
                  <div><b>${i+1}. ${t.name}</b></div>
                  <div><small>${t.artists}</small></div>
                </div>
                <div style="width:140px; text-align:right">${playBtn}</div>
              </div>
            `;
          }).join('');

          $("tracksList").innerHTML = trackHTML;

          // Attach handlers
          document.querySelectorAll('.play-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const url = btn.getAttribute('data-preview');
              // toggle play/pause
              if (btn.classList.contains('playing')) {
                if (currentAudio) currentAudio.pause();
                btn.classList.remove('playing');
              } else {
                playPreview(url, btn);
              }
            });
          });

          setStatus(`‚úÖ Loaded ${data.tracks.length} tracks (previews attached where available)`);
        } catch (error) {
          setStatus(`‚ùå ${error.message}`);
          $("playlistInfo").innerHTML = "";
          $("tracksList").innerHTML = "";
        }
      };

      // Allow Enter key to trigger fetch
      $("playlistLink").addEventListener("keypress", (e) => {
        if (e.key === "Enter") $("fetchBtn").click();
      });
    </script>
  </body>
</html>
