<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MusicGen ‚Äì Playlist Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root { 
        --accent: #1db954; 
        --accent-hover: #17a347;
        --bg: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
        --card: rgba(255, 255, 255, 0.08);
        --card-border: rgba(255, 255, 255, 0.12);
        --text: #e2e8f0;
        --text-light: #a0aec0;
        --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        --shadow-hover: 0 15px 35px 0 rgba(31, 38, 135, 0.4);
      }
      * { box-sizing: border-box; }
      body { 
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
        margin: 0; 
        padding: 64px 32px 32px 32px;
        background: var(--bg);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
        line-height: 1.6;
        font-weight: 400;
        letter-spacing: -0.01em;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0;
      }
      h1 { 
        margin-top: 0;
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        letter-spacing: -0.025em;
        line-height: 1.1;
        position: relative;
        display: inline-block;
        text-align: center;
        width: 100%;
      }
      
      /* Music note animation */
      .music-notes {
        position: absolute;
        top: 0;
        left: -40px;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }
      
      .music-note {
        position: absolute;
        font-size: 1.5rem;
        color: var(--accent);
        opacity: 0.6;
        animation: floatNote 4s ease-in-out infinite;
      }
      
      .music-note:nth-child(1) { left: 10%; animation-delay: 0s; }
      .music-note:nth-child(2) { left: 20%; animation-delay: 1s; font-size: 1.2rem; }
      .music-note:nth-child(3) { left: 30%; animation-delay: 2s; font-size: 1.8rem; }
      .music-note:nth-child(4) { left: 40%; animation-delay: 3s; font-size: 1rem; }
      
      @keyframes floatNote {
        0%, 100% { 
          transform: translateY(0) rotate(0deg); 
          opacity: 0.6; 
        }
        25% { 
          transform: translateY(-15px) rotate(5deg); 
          opacity: 0.8; 
        }
        50% { 
          transform: translateY(-25px) rotate(-3deg); 
          opacity: 1; 
        }
        75% { 
          transform: translateY(-10px) rotate(2deg); 
          opacity: 0.8; 
        }
      }
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        letter-spacing: -0.025em;
        line-height: 1.1;
        position: relative;
        display: inline-block;
        text-align: center;
        width: 100%;
      }
      
      /* Music note animation */
      .music-notes {
        position: absolute;
        top: 0;
        left: -40px;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }
      
      .music-note {
        position: absolute;
        font-size: 1.5rem;
        color: var(--accent);
        opacity: 0.6;
        animation: floatNote 4s ease-in-out infinite;
      }
      
      .music-note:nth-child(1) { left: 10%; animation-delay: 0s; }
      .music-note:nth-child(2) { left: 20%; animation-delay: 1s; font-size: 1.2rem; }
      .music-note:nth-child(3) { left: 30%; animation-delay: 2s; font-size: 1.8rem; }
      .music-note:nth-child(4) { left: 40%; animation-delay: 3s; font-size: 1rem; }
      
      @keyframes floatNote {
        0%, 100% { 
          transform: translateY(0) rotate(0deg); 
          opacity: 0.6; 
        }
        25% { 
          transform: translateY(-15px) rotate(5deg); 
          opacity: 0.8; 
        }
        50% { 
          transform: translateY(-25px) rotate(-3deg); 
          opacity: 1; 
        }
        75% { 
          transform: translateY(-10px) rotate(2deg); 
          opacity: 0.8; 
        }
      }
      
      /* TartanHacks Badge */
      .tartanhacks-badge {
        position: absolute;
        top: -12px;
        right: -20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: mosaicShimmer 3s ease-in-out infinite;
        transform: rotate(8deg);
        z-index: 10;
      }
      
      .tartanhacks-text {
        font-size: 0.6rem;
        margin-bottom: 2px;
        opacity: 0.9;
      }
      
      .mosaic-text {
        font-size: 0.8rem;
        font-weight: 800;
        background: linear-gradient(45deg, #fff, #f0f0f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      @keyframes mosaicShimmer {
        0%, 100% { 
          background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
          transform: rotate(8deg) scale(1);
        }
        50% { 
          background: linear-gradient(135deg, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #ff6b6b);
          transform: rotate(6deg) scale(1.05);
        }
      }
      
      button { 
        padding: 14px 24px;
        margin: 8px 8px 8px 0;
        cursor: pointer;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        letter-spacing: -0.01em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(8px);
        position: relative;
        overflow: hidden;
        font-family: inherit;
      }
      button:hover {
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(0);
      }
      code { 
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.85em;
        backdrop-filter: blur(4px);
        color: var(--text);
      }
      .card { 
        background: var(--card);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }
      
      .card::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, 
          transparent 0%, 
          rgba(255, 107, 107, 0.1) 15%, 
          rgba(78, 205, 196, 0.1) 30%, 
          rgba(69, 183, 209, 0.1) 45%, 
          rgba(150, 206, 180, 0.1) 60%, 
          rgba(254, 202, 87, 0.1) 75%, 
          transparent 100%);
        border-radius: 18px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .card:hover::before {
        opacity: 1;
      }
      
      .card-input {
        max-width: 700px;
        margin: 0 auto 24px auto;
        padding: 32px;
        font-size: 1.1rem;
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
      }
        max-width: 700px;
        margin: 0 auto 24px auto;
        padding: 32px;
        font-size: 1.1rem;
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
        .tartanhacks-badge {
          top: -8px;
          right: -10px;
          padding: 6px 12px;
          font-size: 0.6rem;
          transform: rotate(6deg);
        }
        .tartanhacks-text {
          font-size: 0.5rem;
        }
        .mosaic-text {
          font-size: 0.7rem;
        }
      }
      
      .card-input {
        max-width: 700px;
        margin: 0 auto 24px auto;
        padding: 32px;
        font-size: 1.1rem;
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
      }
      input { 
        padding: 14px 18px;
        width: 100%;
        border: 1px solid var(--card-border);
        border-radius: 12px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        transition: all 0.2s ease;
        color: var(--text);
      }
      input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
        background: rgba(255, 255, 255, 0.08);
      }
      h2 {
        color: var(--text);
        font-weight: 700;
        margin-bottom: 24px;
        font-size: 1.75rem;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }
      small { 
        color: var(--text-light);
        font-weight: 500;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .btn-primary { 
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 14px 28px;
        box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }
      .btn-primary:hover { 
        background: linear-gradient(135deg, #764ba2, #667eea);
        box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.4);
        transform: translateY(-1px);
      }
      .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
      }
      .btn-primary:hover::before {
        left: 100%;
      }
      
      .btn-analyze { 
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        color: white;
        padding: 14px 28px;
        box-shadow: 0 4px 15px 0 rgba(79, 172, 254, 0.3);
        position: relative;
        overflow: hidden;
      }
      .btn-analyze:hover { 
        background: linear-gradient(135deg, #00f2fe, #4facfe);
        box-shadow: 0 6px 20px 0 rgba(79, 172, 254, 0.4);
        transform: translateY(-1px);
      }
      .btn-analyze::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
      }
      .btn-analyze:hover::before {
        left: 100%;
      }
      .btn-analyze:disabled { 
        background: linear-gradient(135deg, #999, #777); 
        cursor: not-allowed; 
        transform: none;
        box-shadow: none;
      }
      .btn-analyze:disabled::before {
        display: none;
      }

      .play-btn { padding: 5px 12px; border: 1px solid #ccc; border-radius: 500px; background: #f5f5f5; font-size: 13px; }
      .play-btn:hover { background: #e0e0e0; }
      .play-btn.playing {
        background: #1db954;
        color: white;
        border-color: #1db954;
        animation: pulse 1.5s ease-in-out infinite;
      }
      .visualize-btn {
        padding: 6px 14px;
        border: 1px solid #2c3e50;
        border-radius: 500px;
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-left: 8px;
        box-shadow: 0 2px 8px rgba(44, 62, 80, 0.3);
      }
      .visualize-btn:hover { 
        background: linear-gradient(135deg, #34495e, #3e5267);
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(44, 62, 80, 0.4);
      }

      .trippify-btn {
        padding: 6px 14px;
        border: 1px solid #ff6b6b;
        border-radius: 500px;
        background: linear-gradient(135deg, #ff6b6b, #ff5252, #e91e63);
        color: white;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-left: 8px;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        animation: trippy-glow 3s ease-in-out infinite;
      }
      .trippify-btn:hover { 
        background: linear-gradient(135deg, #ff5252, #e91e63, #9c27b0);
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(255, 107, 107, 0.5);
      }

      @keyframes trippy-glow {
        0%, 100% { box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); }
        50% { box-shadow: 0 2px 15px rgba(233, 30, 99, 0.6); }
      }
      .audio-visualizer {
        width: 80px;
        height: 30px;
        display: none;
        margin-left: 8px;
      }
      .audio-visualizer.active {
        display: inline-block;
      }
      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(29,185,84,0.4); }
        50% { box-shadow: 0 0 0 8px rgba(29,185,84,0); }
      }

      .track-row { padding: 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; gap: 18px; align-items: flex-start; transition: all 0.2s ease; border-radius: 8px; margin-bottom: 2px; flex-wrap: wrap; }
      .track-row:last-child { border-bottom: none; }
      .track-row.active-track { 
        background: rgba(29, 185, 84, 0.08);
        border: 1px solid rgba(29, 185, 84, 0.2);
        box-shadow: 0 0 0 1px rgba(29, 185, 84, 0.1);
      }
      .track-thumbnail {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .track-thumbnail-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.4);
        flex-shrink: 0;
      }
      .track-info { flex: 1 1 300px; min-width: 0; line-height: 1.5; }
      .track-info > div:first-child {
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        margin-bottom: 4px;
        color: var(--text);
      }
      .track-info small {
        font-size: 0.875rem;
        line-height: 1.4;
      }
      .track-controls { min-width: auto; text-align: right; flex-shrink: 0; display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
      .track-num { color: var(--text-light); min-width: 32px; text-align: right; font-size: 0.875rem; font-weight: 600; padding-top: 2px; letter-spacing: -0.01em; }

      .track-analysis { flex-basis: 100%; min-width: 0; margin-top: 4px; }
      .description-box { margin-top: 10px; padding: 14px 16px; background: rgba(255, 255, 255, 0.06); border-left: 3px solid var(--accent); border-radius: 8px; font-size: 13px; line-height: 1.7; color: var(--text); word-wrap: break-word; overflow-wrap: break-word; }
      .features-toggle { font-size: 12px; color: var(--accent); cursor: pointer; margin-top: 8px; display: inline-block; }
      .features-toggle:hover { text-decoration: underline; }
      .features-detail { display: none; margin-top: 8px; padding: 12px; background: rgba(0, 0, 0, 0.3); color: #e6e6e6; border-radius: 8px; font-size: 12px; line-height: 1.5; overflow-x: auto; white-space: pre-wrap; font-family: 'Fira Code', 'Consolas', monospace; max-height: 400px; overflow-y: auto; }
      .features-detail.open { display: block; }

      .tags { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px; }
      .tag { font-size: 11px; padding: 2px 8px; border-radius: 999px; }
      .tag-genre { background: #e8e0ff; color: #5b21b6; }
      .tag-instrument { background: #dff5e3; color: #166534; }
      .tag-vocal { background: #fef3c7; color: #92400e; }

      .audio-visualizer {
        width: 80px;
        height: 30px;
        display: none;
        margin-right: 8px;
        vertical-align: middle;
      }
      .audio-visualizer.active {
        display: inline-block;
      }

      .trippify-btn {
        padding: 6px 14px;
        border: 1px solid #0066ff;
        border-radius: 500px;
        background: #0066ff;
        color: white;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-left: 8px;
      }
      .trippify-btn:hover { background: #0052cc; }

      .btn-generate {
        padding: 10px 24px;
        border-radius: 500px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.25s;
        letter-spacing: -0.01em;
      }
      .btn-generate:hover { background: linear-gradient(135deg, #7c3aed, #5b21b6); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3); }
      .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
      .generated-song-card { margin-top: 20px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 24px; }
      .generated-song-card h3 { color: #a78bfa; margin: 0 0 12px 0; }
      .generated-song-card audio { width: 100%; margin-top: 12px; border-radius: 8px; }
      .progress-bar { height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px; overflow: hidden; }
      .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }

      .status-badge { display: inline-block; font-size: 12px; padding: 2px 10px; border-radius: 999px; margin-left: 8px; }
      .status-analyzing { background: #fff3cd; color: #856404; }
      .status-done { background: #d4edda; color: #155724; }
      .status-error { background: #f8d7da; color: #721c24; }
      
      .playlist-info-container {
        display: flex;
        gap: 24px;
        align-items: flex-start;
      }
      .playlist-image {
        width: 120px;
        height: 120px;
        border-radius: 16px;
        object-fit: cover;
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .playlist-image:hover {
        transform: scale(1.05) rotate(1deg);
        box-shadow: 0 12px 35px -5px rgba(0, 0, 0, 0.4);
      }
      .playlist-details {
        flex: 1;
        min-width: 0;
      }
      .playlist-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        letter-spacing: -0.02em;
        line-height: 1.3;
      }
      .playlist-meta {
        color: var(--text-light);
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: -0.01em;
      }
      label {
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: -0.01em;
      }
    </style>
  </head>

  <body>
    <div class="container">
    <h1>
      üéµ MusicGen ‚Äì Playlist Analyzer
      <div class="tartanhacks-badge">
        <span class="tartanhacks-text">TartanHacks 2026</span>
        <span class="mosaic-text">MOSAIC</span>
      </div>
      <div class="music-notes">
        <div class="music-note">‚ô™</div>
        <div class="music-note">‚ô´</div>
        <div class="music-note">‚ô™</div>
        <div class="music-note">‚ô¨</div>
      </div>
    </h1>

    <div class="card card-input">
      <label for="playlistLink" style="display:block;margin-bottom:8px;font-weight:bold;text-align:center;">
        Paste a YouTube Music Playlist Link:
      </label>
      <input id="playlistLink" type="text" placeholder="https://music.youtube.com/playlist?list=..." />
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;align-items:center;">
        <button id="fetchBtn" class="btn-primary">üîç Load Playlist</button>
        <button id="analyzeBtn" class="btn-analyze" disabled>üß† Analyze All Tracks</button>
        <button id="generateBtn" class="btn-generate" disabled>üé∂ Generate Song</button>
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--text-light);cursor:pointer;user-select:none;">
          <input type="checkbox" id="vocalsCheckbox" style="accent-color:var(--accent);width:16px;height:16px;cursor:pointer;"> Include vocals
        </label>
      </div>
      <div style="margin-top:12px;text-align:center;">
        <small id="status">Ready to load a playlist</small>
      </div>
      <div id="progressContainer" style="display:none;" class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
    </div>

    <div class="card">
      <h2>Playlist Info</h2>
      <div id="playlistInfo"><small>No playlist loaded</small></div>
    </div>

    <div class="card">
      <h2>Tracks</h2>
      <div id="tracksList"><small>Load a playlist to see tracks</small></div>
    </div>

    <script type="module">
      const $ = id => document.getElementById(id);

      function extractPlaylistId(url) {
        const m = url.match(/list=([a-zA-Z0-9_-]+)/);
        return m ? m[1] : null;
      }

      function setStatus(msg, badge) {
        const el = $("status");
        el.innerHTML = msg + (badge ? ` <span class="status-badge ${badge}">${badge === 'status-analyzing' ? 'Analyzing‚Ä¶' : badge === 'status-done' ? 'Done' : 'Error'}</span>` : '');
      }

      function setProgress(pct) {
        $("progressContainer").style.display = pct === null ? 'none' : 'block';
        if (pct !== null) $("progressFill").style.width = pct + '%';
      }

      // ‚îÄ‚îÄ Audio player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentAudio = null;
      let audioContext = null;
      let analyser = null;
      let animationId = null;

      function clearActiveTrack() {
        document.querySelectorAll('.play-btn.playing').forEach(b => { b.classList.remove('playing'); b.innerHTML = '&#9654; Play 30s'; });
        document.querySelectorAll('.track-row.active-track').forEach(r => r.classList.remove('active-track'));
        document.querySelectorAll('.audio-visualizer.active').forEach(c => c.classList.remove('active'));
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
      }

      function drawVisualizer(canvas, dataArray) {
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const barCount = 20;
        const barWidth = width / barCount;

        ctx.clearRect(0, 0, width, height);
        
        for (let i = 0; i < barCount; i++) {
          const barHeight = (dataArray[i] / 255) * height;
          const x = i * barWidth;
          const y = height - barHeight;
          
          const hue = (i / barCount) * 120 + 120;
          ctx.fillStyle = `hsl(${hue}, 80%, 50%)`;
          ctx.fillRect(x, y, barWidth - 1, barHeight);
        }
      }

      function playPreview(url, btn, idx) {
        if (!url) return;
        if (currentAudio) { currentAudio.pause(); clearActiveTrack(); }

        // Initialize audio context once
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        currentAudio = new Audio(url);
        currentAudio.crossOrigin = "anonymous";
        
        // Create new analyser for each track to avoid reuse issues
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64;
        
        try {
          const source = audioContext.createMediaElementSource(currentAudio);
          source.connect(analyser);
          analyser.connect(audioContext.destination);
        } catch (e) {
          console.warn('AudioContext issue:', e);
          // Fallback: play without visualization
        }

        currentAudio.play().catch(() => {});
        btn.classList.add('playing');
        btn.innerHTML = '&#9646;&#9646; Playing';
        const row = document.querySelector(`.track-row[data-row="${idx}"]`);
        if (row) row.classList.add('active-track');

        // Show and animate visualizer
        const canvas = document.querySelector(`.audio-visualizer[data-idx="${idx}"]`);
        if (canvas && analyser) {
          canvas.classList.add('active');
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);

          function animate() {
            if (currentAudio && !currentAudio.paused) {
              analyser.getByteFrequencyData(dataArray);
              drawVisualizer(canvas, dataArray);
              animationId = requestAnimationFrame(animate);
            }
          }
          animate();
        }
        currentAudio.onended = clearActiveTrack;
      }

      // ‚îÄ‚îÄ Track data store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let playlistId = null;
      let tracksData = [];  // enriched after analysis
      let cachedPlaylistSummary = null;  // cached after analysis for generation

      // ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderTag(label, prob, cat) {
        return `<span class="tag tag-${cat}">${label} ${Math.round(prob * 100)}%</span>`;
      }

      function renderTrack(t, i) {
        const previewUrl = t.deezer?.preview ? `/api/preview-proxy?url=${encodeURIComponent(t.deezer.preview)}` : null;
        const matchInfo = t.deezer ? `Deezer: ${t.deezer.artist} ‚Äì ${t.deezer.title}` : '';
        const playBtn = previewUrl
          ? `<button class="play-btn" data-preview="${previewUrl}" data-idx="${i}">&#9654; Play 30s</button>`
          : `<small style="color:#999">No preview</small>`;
        const visualizeBtn = previewUrl
          ? `<a class="visualize-btn" href="/visualize_song?url=${encodeURIComponent(previewUrl)}&name=${encodeURIComponent(t.name)}&artist=${encodeURIComponent(t.artist || t.artists)}" target="_blank">‚ú® Visualize</a>`
          : '';
        const trippifyBtn = previewUrl
          ? `<a class="trippify-btn" href="/trippify_song?url=${encodeURIComponent(previewUrl)}&name=${encodeURIComponent(t.name)}&artist=${encodeURIComponent(t.artist || t.artists)}" target="_blank">üåÄ Trippify</a>`
          : '';

        // Track thumbnail
        const thumbnailHTML = t.thumbnail 
          ? `<img src="${t.thumbnail}" alt="${t.name}" class="track-thumbnail" loading="lazy">`
          : `<div class="track-thumbnail-placeholder">üéµ</div>`;

        let analysisHTML = '';
        if (t.description) {
          analysisHTML += `<div class="description-box">${t.description}</div>`;
        }

        // Tags
        if (t.tags) {
          let tagHTML = '';
          for (const g of (t.tags.genre || [])) tagHTML += renderTag(g.label, g.prob, 'genre');
          for (const g of (t.tags.instrument || [])) tagHTML += renderTag(g.label, g.prob, 'instrument');
          for (const g of (t.tags.vocal || [])) tagHTML += renderTag(g.label, g.prob, 'vocal');
          if (tagHTML) analysisHTML += `<div class="tags">${tagHTML}</div>`;
        }

        // Collapsible raw features
        if (t.audio_features) {
          analysisHTML += `<span class="features-toggle" data-idx="${i}">‚ñ∏ Raw audio features</span>`;
          analysisHTML += `<div class="features-detail" id="feats-${i}">${JSON.stringify(t.audio_features, null, 2)}</div>`;
        }

        return `
          <div class="track-row" data-row="${i}">
            <div class="track-num">${i + 1}</div>
            ${thumbnailHTML}
            <div class="track-info">
              <div><b>${t.name}</b></div>
              <div><small>${t.artist || t.artists || ''} ¬∑ ${t.duration || ''}</small></div>
              ${matchInfo ? `<div><small style="color:var(--accent)">${matchInfo}</small></div>` : ''}
            </div>
            <div class="track-controls">
              <canvas class="audio-visualizer" data-idx="${i}" width="80" height="30"></canvas>
              ${playBtn}
              ${visualizeBtn}
              ${trippifyBtn}
            </div>
            ${analysisHTML ? `<div class="track-analysis">${analysisHTML}</div>` : ''}
          </div>`;
      }

      function renderAllTracks() {
        $("tracksList").innerHTML = tracksData.map(renderTrack).join('');
        attachHandlers();
      }

      function attachHandlers() {
        document.querySelectorAll('.play-btn').forEach(btn => {
          btn.onclick = () => {
            const url = btn.dataset.preview;
            const idx = btn.dataset.idx;
            if (btn.classList.contains('playing')) { if (currentAudio) currentAudio.pause(); clearActiveTrack(); }
            else { clearActiveTrack(); playPreview(url, btn, idx); }
          };
        });
        document.querySelectorAll('.features-toggle').forEach(tog => {
          tog.onclick = () => {
            const el = $('feats-' + tog.dataset.idx);
            if (el) { el.classList.toggle('open'); tog.textContent = el.classList.contains('open') ? '‚ñæ Raw audio features' : '‚ñ∏ Raw audio features'; }
          };
        });
      }

      // ‚îÄ‚îÄ Load playlist (Deezer previews only, fast) ‚îÄ‚îÄ
      $("fetchBtn").onclick = async () => {
        const link = $("playlistLink").value.trim();
        if (!link) { setStatus("‚ùå Paste a YouTube Music playlist link"); return; }
        playlistId = extractPlaylistId(link);
        if (!playlistId) { setStatus("‚ùå Invalid playlist link"); return; }

        try {
          setStatus("‚è≥ Fetching playlist & matching Deezer previews‚Ä¶");
          setProgress(null);
          $("analyzeBtn").disabled = true;

          const resp = await fetch(`/api/playlist/${playlistId}/deezer-previews`);
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);
          const data = await resp.json();

          // Check if we have playlist image from the more detailed endpoint
          let playlistImageUrl = null;
          try {
            const detailResp = await fetch(`/api/playlist/${playlistId}`);
            if (detailResp.ok) {
              const detailData = await detailResp.json();
              playlistImageUrl = detailData.image;
            }
          } catch (e) { /* ignore */ }

          const imageHTML = playlistImageUrl 
            ? `<img src="${playlistImageUrl}" alt="Playlist cover" class="playlist-image" />`
            : '';
          
          $("playlistInfo").innerHTML = `
            <div class="playlist-info-container">
              ${imageHTML}
              <div class="playlist-details">
                <div class="playlist-title">${data.playlist.name}</div>
                <div class="playlist-meta">${data.playlist.totalTracks} tracks</div>
              </div>
            </div>
          `;

          tracksData = data.tracks.map(t => ({
            name: t.name,
            artist: t.artists,
            duration: t.duration,
            deezer: t.deezer,
            audio_features: null,
            tags: null,
            description: null,
          }));

          renderAllTracks();
          $("analyzeBtn").disabled = false;
          setStatus(`‚úÖ Loaded ${tracksData.length} tracks. Hit <b>Analyze</b> for audio analysis + descriptions.`);
        } catch (e) {
          setStatus(`‚ùå ${e.message}`);
        }
      };

      // ‚îÄ‚îÄ Analyze all tracks (calls Flask backend) ‚îÄ‚îÄ
      $("analyzeBtn").onclick = async () => {
        if (!playlistId || tracksData.length === 0) return;

        $("analyzeBtn").disabled = true;
        setStatus("üß† Analyzing audio features, tagging, and generating descriptions‚Ä¶", 'status-analyzing');
        setProgress(10);

        try {
          const resp = await fetch(`/api/playlist/${playlistId}/analysis`);
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);

          setProgress(80);
          const data = await resp.json();

          // Merge analysis into our store
          tracksData = data.tracks.map(t => ({
            name: t.name,
            artist: t.artist,
            duration: t.duration,
            deezer: t.deezer,
            audio_features: t.audio_features,
            tags: t.tags,
            description: t.description,
          }));

          renderAllTracks();
          setProgress(100);

          const analyzed = tracksData.filter(t => t.audio_features).length;
          let statusMsg = `‚úÖ ${analyzed}/${tracksData.length} tracks analyzed with audio features + descriptions.`;
          
          // Cache and display GPT-4 playlist summary
          cachedPlaylistSummary = data.playlist_summary || null;
          if (data.playlist_summary) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'card';
            summaryDiv.style.marginTop = '20px';
            summaryDiv.style.background = 'rgba(29, 185, 84, 0.1)';
            summaryDiv.style.border = '1px solid rgba(29, 185, 84, 0.3)';
            summaryDiv.innerHTML = `
              <h3 style="margin-bottom: 12px; color: var(--accent);">üéµ AI Music Generation Prompt</h3>
              <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                ${data.playlist_summary}
              </div>
              <small style="display: block; margin-top: 10px; opacity: 0.7;">Generated by GPT-4 based on audio analysis</small>
            `;
            
            // Insert after playlistInfo
            const playlistInfo = $('playlistInfo');
            if (playlistInfo.nextSibling) {
              playlistInfo.parentNode.insertBefore(summaryDiv, playlistInfo.nextSibling);
            } else {
              playlistInfo.parentNode.appendChild(summaryDiv);
            }
          }
          
          setStatus(statusMsg, 'status-done');
          $("generateBtn").disabled = false;
          setTimeout(() => setProgress(null), 2000);
        } catch (e) {
          setStatus(`‚ùå Analysis failed: ${e.message}`, 'status-error');
          setProgress(null);
        } finally {
          $("analyzeBtn").disabled = false;
        }
      };

      // ‚îÄ‚îÄ Generate song via DiffRhythm (uses cached summary) ‚îÄ‚îÄ
      $("generateBtn").onclick = async () => {
        if (!cachedPlaylistSummary) {
          setStatus('‚ùå Run Analyze first to generate a playlist summary.', 'status-error');
          return;
        }
        const withLyrics = $("vocalsCheckbox").checked;
        $("generateBtn").disabled = true;
        $("generateBtn").textContent = withLyrics ? 'üé§ Generating with vocals‚Ä¶' : 'üé∂ Generating‚Ä¶';
        setStatus(withLyrics
          ? 'üé§ Writing lyrics & generating song‚Ä¶ This may take 2-4 minutes.'
          : 'üéµ Generating instrumental with DiffRhythm‚Ä¶ This may take 1-3 minutes.', 'status-analyzing');
        setProgress(10);

        // Remove any previous generated song card
        const prev = document.querySelector('.generated-song-card');
        if (prev) prev.remove();

        try {
          const resp = await fetch('/api/diffrhythm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: cachedPlaylistSummary,
              options: { duration: 95, steps: 50, file_type: 'mp3', withLyrics }
            })
          });
          setProgress(80);
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);
          const result = await resp.json();
          setProgress(100);

          if (result.url) {
            const lyricsBlock = result.lyrics_used && result.lyrics_used !== '[00:00.00] Instrumental'
              ? `<details style="margin-bottom:12px;"><summary style="cursor:pointer;color:var(--accent);font-size:13px;">üé§ Generated Lyrics</summary><pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;font-size:12px;line-height:1.6;margin-top:8px;white-space:pre-wrap;color:var(--text);">${result.lyrics_used}</pre></details>`
              : '';
            const card = document.createElement('div');
            card.className = 'generated-song-card card';
            card.innerHTML = `
              <h3>üé∂ Generated Song ${withLyrics ? '(with vocals)' : '(instrumental)'}</h3>
              <p style="font-size: 14px; opacity: 0.8; margin: 0 0 8px 0;">Based on the audio analysis of your playlist</p>
              <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; margin-bottom: 12px;"><strong>Style prompt:</strong> ${cachedPlaylistSummary}</div>
              ${lyricsBlock}
              <audio controls src="${result.url}"></audio>
              <a href="${result.url}" download style="display:inline-block;margin-top:10px;color:#a78bfa;font-size:13px;">‚¨á Download</a>
            `;
            const playlistInfo = $('playlistInfo');
            const existingSummary = playlistInfo.nextElementSibling;
            if (existingSummary && existingSummary.innerHTML.includes('Music Generation Prompt')) {
              existingSummary.parentNode.insertBefore(card, existingSummary.nextSibling);
            } else if (playlistInfo.nextSibling) {
              playlistInfo.parentNode.insertBefore(card, playlistInfo.nextSibling);
            } else {
              playlistInfo.parentNode.appendChild(card);
            }
            setStatus('‚úÖ Song generated successfully!', 'status-done');
          } else {
            setStatus('‚ö†Ô∏è Song generated but no audio URL returned.', 'status-error');
          }
          setTimeout(() => setProgress(null), 2000);
        } catch (e) {
          setStatus(`‚ùå Song generation failed: ${e.message}`, 'status-error');
          setProgress(null);
        } finally {
          $("generateBtn").disabled = false;
          $("generateBtn").textContent = 'üé∂ Generate Song';
        }
      };

      $("playlistLink").addEventListener("keypress", e => { if (e.key === "Enter") $("fetchBtn").click(); });
    </script>
    </div>
  </body>
</html>
