<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MusicGen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.3.0/simplex-noise.min.js"></script>
    <style>
      :root { 
        --accent: #1db954; 
        --accent-hover: #17a347;
        --bg: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
        --card: rgba(255, 255, 255, 0.08);
        --card-border: rgba(255, 255, 255, 0.12);
        --text: #e2e8f0;
        --text-light: #a0aec0;
        --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        --shadow-hover: 0 15px 35px 0 rgba(31, 38, 135, 0.4);
      }
      * { box-sizing: border-box; }
      body { 
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
        margin: 0; 
        padding: 64px 32px 32px 32px;
        background: var(--bg);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
        line-height: 1.6;
        font-weight: 400;
        letter-spacing: -0.01em;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0;
      }
      h1 { 
        margin-top: 0;
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
        letter-spacing: -0.025em;
        line-height: 1.1;
        position: relative;
        display: inline-block;
        text-align: center;
        width: 100%;
      }
      
      /* Music note animation */
      .music-notes {
        position: absolute;
        top: 0;
        left: -40px;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }
      
      .music-note {
        position: absolute;
        font-size: 1.5rem;
        color: var(--accent);
        opacity: 0.6;
        animation: floatNote 4s ease-in-out infinite;
      }
      
      .music-note:nth-child(1) { left: 10%; animation-delay: 0s; }
      .music-note:nth-child(2) { left: 20%; animation-delay: 1s; font-size: 1.2rem; }
      .music-note:nth-child(3) { left: 30%; animation-delay: 2s; font-size: 1.8rem; }
      .music-note:nth-child(4) { left: 40%; animation-delay: 3s; font-size: 1rem; }
      
      @keyframes floatNote {
        0%, 100% { 
          transform: translateY(0) rotate(0deg); 
          opacity: 0.6; 
        }
        25% { 
          transform: translateY(-15px) rotate(5deg); 
          opacity: 0.8; 
        }
        50% { 
          transform: translateY(-25px) rotate(-3deg); 
          opacity: 1; 
        }
        75% { 
          transform: translateY(-10px) rotate(2deg); 
          opacity: 0.8; 
        }
      }
      
      /* Music note animation */
      .music-notes {
        position: absolute;
        top: 0;
        left: -40px;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }
      
      .music-note {
        position: absolute;
        font-size: 1.5rem;
        color: var(--accent);
        opacity: 0.6;
        animation: floatNote 4s ease-in-out infinite;
      }
      
      .music-note:nth-child(1) { left: 10%; animation-delay: 0s; }
      .music-note:nth-child(2) { left: 20%; animation-delay: 1s; font-size: 1.2rem; }
      .music-note:nth-child(3) { left: 30%; animation-delay: 2s; font-size: 1.8rem; }
      .music-note:nth-child(4) { left: 40%; animation-delay: 3s; font-size: 1rem; }
      
      @keyframes floatNote {
        0%, 100% { 
          transform: translateY(0) rotate(0deg); 
          opacity: 0.6; 
        }
        25% { 
          transform: translateY(-15px) rotate(5deg); 
          opacity: 0.8; 
        }
        50% { 
          transform: translateY(-25px) rotate(-3deg); 
          opacity: 1; 
        }
        75% { 
          transform: translateY(-10px) rotate(2deg); 
          opacity: 0.8; 
        }
      }
      
      /* TartanHacks Badge */
      .tartanhacks-badge {
        position: absolute;
        top: -12px;
        right: -20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: mosaicShimmer 3s ease-in-out infinite;
        transform: rotate(8deg);
        z-index: 10;
      }
      
      .tartanhacks-text {
        font-size: 0.6rem;
        margin-bottom: 2px;
        opacity: 0.9;
      }
      
      .mosaic-text {
        font-size: 0.8rem;
        font-weight: 800;
        background: linear-gradient(45deg, #fff, #f0f0f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      @keyframes mosaicShimmer {
        0%, 100% { 
          background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
          transform: rotate(8deg) scale(1);
        }
        50% { 
          background: linear-gradient(135deg, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3, #ff6b6b);
          transform: rotate(6deg) scale(1.05);
        }
      }
      
      button { 
        padding: 14px 24px;
        margin: 8px 8px 8px 0;
        cursor: pointer;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        letter-spacing: -0.01em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(8px);
        position: relative;
        overflow: hidden;
        font-family: inherit;
      }
      button:hover {
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(0);
      }
      code { 
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.85em;
        backdrop-filter: blur(4px);
        color: var(--text);
      }
      .card { 
        background: var(--card);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
      }
      
      .card::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, 
          transparent 0%, 
          rgba(255, 107, 107, 0.1) 15%, 
          rgba(78, 205, 196, 0.1) 30%, 
          rgba(69, 183, 209, 0.1) 45%, 
          rgba(150, 206, 180, 0.1) 60%, 
          rgba(254, 202, 87, 0.1) 75%, 
          transparent 100%);
        border-radius: 18px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .card:hover::before {
        opacity: 1;
      }
      
      .card-input {
        max-width: 700px;
        margin: 0 auto 24px auto;
        padding: 32px;
        font-size: 1.1rem;
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
        .tartanhacks-badge {
          top: -8px;
          right: -10px;
          padding: 6px 12px;
          font-size: 0.6rem;
          transform: rotate(6deg);
        }
        .tartanhacks-text {
          font-size: 0.5rem;
        }
        .mosaic-text {
          font-size: 0.7rem;
        }
      }
      
      .card-input {
        max-width: 700px;
        margin: 0 auto 24px auto;
        padding: 32px;
        font-size: 1.1rem;
      }
      
      .card-input label {
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .card-input input {
        font-size: 17px;
        padding: 18px 22px;
      }
      
      .card-input button {
        font-size: 16px;
        padding: 16px 32px;
      }
      
      .card:not(.card-input) {
        max-width: 900px;
        margin: 0 auto 24px auto;
      }
      
      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        body {
          padding: 48px 16px 32px 16px;
        }
        .card-input {
          max-width: 100%;
          padding: 24px;
          font-size: 1rem;
        }
        .card-input label {
          font-size: 1.1rem;
        }
        .card-input input {
          font-size: 16px;
          padding: 14px 18px;
        }
        .card-input button {
          font-size: 15px;
          padding: 14px 24px;
        }
        .card:not(.card-input) {
          max-width: 100%;
        }
      }
      input { 
        padding: 14px 18px;
        width: 100%;
        border: 1px solid var(--card-border);
        border-radius: 12px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        transition: all 0.2s ease;
        color: var(--text);
      }
      input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
        background: rgba(255, 255, 255, 0.08);
      }
      h2 {
        color: var(--text);
        font-weight: 700;
        margin-bottom: 24px;
        font-size: 1.75rem;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }
      small { 
        color: var(--text-light);
        font-weight: 500;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .btn-primary { 
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 14px 28px;
        box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }
      .btn-primary:hover { 
        background: linear-gradient(135deg, #764ba2, #667eea);
        box-shadow: 0 6px 20px 0 rgba(102, 126, 234, 0.4);
        transform: translateY(-1px);
      }
      .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
      }
      .btn-primary:hover::before {
        left: 100%;
      }
      
      .btn-analyze { 
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        color: white;
        padding: 14px 28px;
        box-shadow: 0 4px 15px 0 rgba(79, 172, 254, 0.3);
        position: relative;
        overflow: hidden;
      }
      .btn-analyze:hover { 
        background: linear-gradient(135deg, #00f2fe, #4facfe);
        box-shadow: 0 6px 20px 0 rgba(79, 172, 254, 0.4);
        transform: translateY(-1px);
      }
      .btn-analyze::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
      }
      .btn-analyze:hover::before {
        left: 100%;
      }
      .btn-analyze:disabled { 
        background: linear-gradient(135deg, #999, #777); 
        cursor: not-allowed; 
        transform: none;
        box-shadow: none;
      }
      .btn-analyze:disabled::before {
        display: none;
      }

      .play-btn { padding: 5px 12px; border: 1px solid #ccc; border-radius: 500px; background: #f5f5f5; font-size: 13px; }
      .play-btn:hover { background: #e0e0e0; }
      .play-btn.playing {
        background: #1db954;
        color: white;
        border-color: #1db954;
        animation: pulse 1.5s ease-in-out infinite;
      }
      .visualize-btn {
        padding: 6px 14px;
        border: 1px solid rgba(139, 92, 246, 0.5);
        border-radius: 500px;
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        color: white;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-left: 8px;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        line-height: 1.4;
      }
      .visualize-btn:hover { 
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(124, 58, 237, 0.5);
      }


      .audio-visualizer {
        width: 80px;
        height: 30px;
        display: none;
        margin-left: 8px;
      }
      .audio-visualizer.active {
        display: inline-block;
      }
      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(29,185,84,0.4); }
        50% { box-shadow: 0 0 0 8px rgba(29,185,84,0); }
      }

      .track-row { padding: 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; gap: 18px; align-items: flex-start; transition: all 0.2s ease; border-radius: 8px; margin-bottom: 2px; flex-wrap: wrap; }
      .track-row:last-child { border-bottom: none; }
      .track-row.active-track { 
        background: rgba(29, 185, 84, 0.08);
        border: 1px solid rgba(29, 185, 84, 0.2);
        box-shadow: 0 0 0 1px rgba(29, 185, 84, 0.1);
      }
      .track-thumbnail {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .track-thumbnail-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.4);
        flex-shrink: 0;
      }
      .track-info { flex: 1 1 300px; min-width: 0; line-height: 1.5; }
      .track-info > div:first-child {
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        margin-bottom: 4px;
        color: var(--text);
      }
      .track-info small {
        font-size: 0.875rem;
        line-height: 1.4;
      }
      .track-controls { min-width: auto; text-align: right; flex-shrink: 0; display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
      .track-num { color: var(--text-light); min-width: 32px; text-align: right; font-size: 0.875rem; font-weight: 600; padding-top: 2px; letter-spacing: -0.01em; }

      .track-analysis { flex-basis: 100%; min-width: 0; margin-top: 4px; }
      .description-box { margin-top: 10px; padding: 14px 16px; background: rgba(255, 255, 255, 0.06); border-left: 3px solid var(--accent); border-radius: 8px; font-size: 13px; line-height: 1.7; color: var(--text); word-wrap: break-word; overflow-wrap: break-word; }
      .features-toggle { font-size: 12px; color: var(--accent); cursor: pointer; margin-top: 8px; display: inline-block; }
      .features-toggle:hover { text-decoration: underline; }
      .features-detail { display: none; margin-top: 8px; padding: 12px; background: rgba(0, 0, 0, 0.3); color: #e6e6e6; border-radius: 8px; font-size: 12px; line-height: 1.5; overflow-x: auto; white-space: pre-wrap; font-family: 'Fira Code', 'Consolas', monospace; max-height: 400px; overflow-y: auto; }
      .features-detail.open { display: block; }

      .tags { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px; }
      .tag { font-size: 11px; padding: 2px 8px; border-radius: 999px; }
      .tag-genre { background: #e8e0ff; color: #5b21b6; }
      .tag-instrument { background: #dff5e3; color: #166534; }
      .tag-vocal { background: #fef3c7; color: #92400e; }

      .audio-visualizer {
        width: 80px;
        height: 30px;
        display: none;
        margin-right: 8px;
        vertical-align: middle;
      }
      .audio-visualizer.active {
        display: inline-block;
      }



      .btn-generate {
        padding: 10px 24px;
        border-radius: 500px;
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: white;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.25s;
        letter-spacing: -0.01em;
      }
      .btn-generate:hover { background: linear-gradient(135deg, #7c3aed, #5b21b6); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3); }
      .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
      .generated-song-card { margin-top: 20px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 24px; }
      .generated-song-card h3 { color: #a78bfa; margin: 0 0 12px 0; }
      .generated-song-card audio { width: 100%; margin-top: 12px; border-radius: 8px; }
      .progress-bar { height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px; overflow: hidden; }
      .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }

      .status-badge { display: inline-block; font-size: 12px; padding: 2px 10px; border-radius: 999px; margin-left: 8px; }
      .status-analyzing { background: #fff3cd; color: #856404; }
      .status-done { background: #d4edda; color: #155724; }
      .status-error { background: #f8d7da; color: #721c24; }
      
      .playlist-info-container {
        display: flex;
        gap: 24px;
        align-items: flex-start;
      }
      .playlist-image {
        width: 120px;
        height: 120px;
        border-radius: 16px;
        object-fit: cover;
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .playlist-image:hover {
        transform: scale(1.05) rotate(1deg);
        box-shadow: 0 12px 35px -5px rgba(0, 0, 0, 0.4);
      }
      .playlist-details {
        flex: 1;
        min-width: 0;
      }
      .playlist-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        letter-spacing: -0.02em;
        line-height: 1.3;
      }
      .playlist-meta {
        color: var(--text-light);
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: -0.01em;
      }
      label {
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: -0.01em;
      }

      /* ‚îÄ‚îÄ Fullscreen visualizer overlay ‚îÄ‚îÄ */
      #vizOverlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: #000;
        display: none;
        flex-direction: column;
      }
      #vizOverlay.active { display: flex; }
      #vizOverlay canvas { display: block; width: 100%; height: 100%; }
      .viz-top-bar {
        position: absolute;
        top: 0; left: 0; right: 0;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px 24px;
        pointer-events: none;
      }
      .viz-song-info {
        pointer-events: auto;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.08);
        padding: 12px 20px;
        border-radius: 12px;
      }
      .viz-song-name { font-size: 15px; font-weight: 600; }
      .viz-song-artist { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 2px; }
      .viz-close-btn {
        pointer-events: auto;
        padding: 8px 16px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.2s;
      }
      .viz-close-btn:hover { background: rgba(255,255,255,0.2); }
      .viz-bottom-bar {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        z-index: 10;
        padding: 20px 24px 28px;
        display: flex;
        justify-content: center;
        pointer-events: none;
      }
      .viz-player {
        pointer-events: auto;
        background: rgba(10,10,20,0.65);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 16px 24px;
        border-radius: 18px;
        width: 100%;
        max-width: 560px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .viz-player-row {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .viz-play-btn {
        width: 44px; height: 44px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #a78bfa, #6d28d9);
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: transform 0.15s, box-shadow 0.2s;
        box-shadow: 0 0 16px rgba(167,139,250,0.3);
      }
      .viz-play-btn:hover { transform: scale(1.1); box-shadow: 0 0 24px rgba(167,139,250,0.5); }
      .viz-play-btn:active { transform: scale(0.95); }
      .viz-progress-wrap {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .viz-progress-bar {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(255,255,255,0.12);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      .viz-progress-fill {
        height: 100%;
        border-radius: 3px;
        background: linear-gradient(90deg, #a78bfa, #c084fc, #e879f9);
        width: 0%;
        transition: width 0.1s linear;
      }
      .viz-time-row {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: rgba(255,255,255,0.45);
        font-variant-numeric: tabular-nums;
      }
      .viz-vol-wrap {
        flex-shrink: 0;
        position: relative;
        display: flex;
        align-items: center;
      }
      .viz-vol-icon {
        font-size: 18px;
        color: rgba(255,255,255,0.65);
        cursor: pointer;
        transition: color 0.2s;
        padding: 6px;
        z-index: 2;
      }
      .viz-vol-icon:hover { color: #c084fc; }
      .viz-vol-popup {
        position: absolute;
        bottom: calc(100% + 0px);
        left: 50%;
        transform: translateX(-50%) scaleY(0);
        transform-origin: bottom center;
        opacity: 0;
        transition: transform 0.25s cubic-bezier(0.4,0,0.2,1), opacity 0.2s ease;
        background: rgba(10,10,20,0.75);
        backdrop-filter: blur(14px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        padding: 16px 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        pointer-events: none;
      }
      /* Invisible bridge between icon and popup to prevent hover gap */
      .viz-vol-popup::after {
        content: '';
        position: absolute;
        bottom: -16px;
        left: 0;
        right: 0;
        height: 16px;
      }
      .viz-vol-wrap:hover .viz-vol-popup,
      .viz-vol-wrap.vol-active .viz-vol-popup {
        transform: translateX(-50%) scaleY(1);
        opacity: 1;
        pointer-events: auto;
      }
      .viz-vol-pct {
        font-size: 10px;
        color: rgba(255,255,255,0.5);
        font-variant-numeric: tabular-nums;
      }
      .viz-vol-slider {
        -webkit-appearance: none;
        appearance: none;
        width: 4px;
        height: 90px;
        border-radius: 2px;
        background: rgba(255,255,255,0.15);
        outline: none;
        writing-mode: vertical-lr;
        direction: rtl;
      }
      .viz-vol-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px; height: 16px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c084fc, #a78bfa);
        cursor: pointer;
        box-shadow: 0 0 10px rgba(192,132,252,0.6);
      }
      .viz-vol-slider::-webkit-slider-thumb:hover {
        box-shadow: 0 0 16px rgba(192,132,252,0.9);
      }
      .viz-vol-slider::-moz-range-thumb {
        width: 16px; height: 16px;
        border-radius: 50%;
        background: linear-gradient(135deg, #c084fc, #a78bfa);
        cursor: pointer;
        border: none;
        box-shadow: 0 0 10px rgba(192,132,252,0.6);
      }
      .viz-vol-slider::-moz-range-track {
        width: 4px;
        background: rgba(255,255,255,0.15);
        border: none;
        border-radius: 2px;
      }
      #vizAudio { display: none; }
    </style>
  </head>

  <body>
    <div class="container">
    <h1>
      üéµ MusicGen
      <div class="tartanhacks-badge">
        <span class="tartanhacks-text">TartanHacks 2026</span>
        <span class="mosaic-text">MOSAIC</span>
      </div>
      <div class="music-notes">
        <div class="music-note">‚ô™</div>
        <div class="music-note">‚ô´</div>
        <div class="music-note">‚ô™</div>
        <div class="music-note">‚ô¨</div>
      </div>
    </h1>

    <div class="card card-input">
      <label for="playlistLink" style="display:block;margin-bottom:8px;font-weight:bold;text-align:center;">
        Paste a YouTube Music Playlist Link:
      </label>
      <input id="playlistLink" type="text" placeholder="https://music.youtube.com/playlist?list=..." />
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;align-items:center;">
        <button id="fetchBtn" class="btn-primary">üîç Load Playlist</button>
        <button id="generateBtn" class="btn-generate" disabled>üé∂ Generate Song</button>
        <label style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--text-light);cursor:pointer;user-select:none;">
          <input type="checkbox" id="instrumentalCheckbox" style="accent-color:var(--accent);width:16px;height:16px;cursor:pointer;"> Instrumental only
        </label>
      </div>
      <div style="margin-top:12px;text-align:center;">
        <small id="status">Ready to load a playlist</small>
      </div>
      <div id="progressContainer" style="display:none;" class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
    </div>

    <div class="card">
      <h2>Playlist Info</h2>
      <div id="playlistInfo"><small>No playlist loaded</small></div>
    </div>

    <div class="card">
      <h2>Tracks</h2>
      <div id="tracksList"><small>Load a playlist to see tracks</small></div>
    </div>

    <script type="module">
      const $ = id => document.getElementById(id);

      function extractPlaylistId(url) {
        const m = url.match(/list=([a-zA-Z0-9_-]+)/);
        return m ? m[1] : null;
      }

      function setStatus(msg, badge) {
        const el = $("status");
        el.innerHTML = msg + (badge ? ` <span class="status-badge ${badge}">${badge === 'status-analyzing' ? 'Analyzing‚Ä¶' : badge === 'status-done' ? 'Done' : 'Error'}</span>` : '');
      }

      function setProgress(pct) {
        $("progressContainer").style.display = pct === null ? 'none' : 'block';
        if (pct !== null) $("progressFill").style.width = pct + '%';
      }

      // Simulated progress that smoothly fills to ~90% over estimatedMs
      let _simInterval = null;
      function startSimulatedProgress(estimatedMs) {
        stopSimulatedProgress();
        let pct = 5;
        setProgress(pct);
        const step = 200;
        const totalSteps = estimatedMs / step;
        const increment = 85 / totalSteps;
        _simInterval = setInterval(() => {
          pct = Math.min(pct + increment * (1 - pct / 100), 90);
          setProgress(Math.round(pct));
        }, step);
      }
      function stopSimulatedProgress() {
        if (_simInterval) { clearInterval(_simInterval); _simInterval = null; }
      }

      // ‚îÄ‚îÄ Audio player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentAudio = null;
      let audioContext = null;
      let analyser = null;
      let animationId = null;

      function clearActiveTrack() {
        document.querySelectorAll('.play-btn.playing').forEach(b => { b.classList.remove('playing'); b.innerHTML = '&#9654; Play 30s'; });
        document.querySelectorAll('.track-row.active-track').forEach(r => r.classList.remove('active-track'));
        document.querySelectorAll('.audio-visualizer.active').forEach(c => c.classList.remove('active'));
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
      }

      function drawVisualizer(canvas, dataArray) {
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const barCount = 20;
        const barWidth = width / barCount;

        ctx.clearRect(0, 0, width, height);
        
        for (let i = 0; i < barCount; i++) {
          const barHeight = (dataArray[i] / 255) * height;
          const x = i * barWidth;
          const y = height - barHeight;
          
          const hue = (i / barCount) * 120 + 120;
          ctx.fillStyle = `hsl(${hue}, 80%, 50%)`;
          ctx.fillRect(x, y, barWidth - 1, barHeight);
        }
      }

      function playPreview(url, btn, idx) {
        if (!url) return;
        if (currentAudio) { currentAudio.pause(); clearActiveTrack(); }

        // Initialize audio context once
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        currentAudio = new Audio(url);
        currentAudio.crossOrigin = "anonymous";
        
        // Create new analyser for each track to avoid reuse issues
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64;
        
        try {
          const source = audioContext.createMediaElementSource(currentAudio);
          source.connect(analyser);
          analyser.connect(audioContext.destination);
        } catch (e) {
          console.warn('AudioContext issue:', e);
          // Fallback: play without visualization
        }

        currentAudio.play().catch(() => {});
        btn.classList.add('playing');
        btn.innerHTML = '&#9646;&#9646; Playing';
        const row = document.querySelector(`.track-row[data-row="${idx}"]`);
        if (row) row.classList.add('active-track');

        // Show and animate visualizer
        const canvas = document.querySelector(`.audio-visualizer[data-idx="${idx}"]`);
        if (canvas && analyser) {
          canvas.classList.add('active');
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);

          function animate() {
            if (currentAudio && !currentAudio.paused) {
              analyser.getByteFrequencyData(dataArray);
              drawVisualizer(canvas, dataArray);
              animationId = requestAnimationFrame(animate);
            }
          }
          animate();
        }
        currentAudio.onended = clearActiveTrack;
      }

      // ‚îÄ‚îÄ Track data store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let playlistId = null;
      let tracksData = [];  // enriched after analysis
      let cachedPlaylistSummary = null;  // cached after analysis for generation

      // ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderTag(label, prob, cat) {
        return `<span class="tag tag-${cat}">${label} ${Math.round(prob * 100)}%</span>`;
      }

      function renderTrack(t, i) {
        const previewUrl = t.deezer?.preview ? `/api/preview-proxy?url=${encodeURIComponent(t.deezer.preview)}` : null;
        const matchInfo = t.deezer ? `Deezer: ${t.deezer.artist} ‚Äì ${t.deezer.title}` : '';
        const playBtn = previewUrl
          ? `<button class="play-btn" data-preview="${previewUrl}" data-idx="${i}">&#9654; Play 30s</button>`
          : `<small style="color:#999">No preview</small>`;
        const visualizeBtn = previewUrl
          ? `<button class="visualize-btn" data-viz-url="${previewUrl}" data-viz-name="${(t.name||'').replace(/"/g, '&quot;')}" data-viz-artist="${((t.artist||t.artists||'')).replace(/"/g, '&quot;')}">üîÆ Visualize</button>`
          : '';

        // Track thumbnail: prefer YouTube thumbnail, fall back to Deezer album cover
        const thumbSrc = t.thumbnail || t.deezer?.cover || null;
        const thumbnailHTML = thumbSrc
          ? `<img src="${thumbSrc}" alt="${t.name}" class="track-thumbnail" loading="lazy">`
          : `<div class="track-thumbnail-placeholder">üéµ</div>`;

        let analysisHTML = '';
        // Descriptions, tags, and raw features are kept internally but hidden from the UI

        return `
          <div class="track-row" data-row="${i}">
            <div class="track-num">${i + 1}</div>
            ${thumbnailHTML}
            <div class="track-info">
              <div><b>${t.name}</b></div>
              <div><small>${t.artist || t.artists || ''} ¬∑ ${t.duration || ''}</small></div>
              ${matchInfo ? `<div><small style="color:var(--accent)">${matchInfo}</small></div>` : ''}
            </div>
            <div class="track-controls">
              <canvas class="audio-visualizer" data-idx="${i}" width="80" height="30"></canvas>
              ${playBtn}
              ${visualizeBtn}
            </div>
            ${analysisHTML ? `<div class="track-analysis">${analysisHTML}</div>` : ''}
          </div>`;
      }

      function renderAllTracks() {
        $("tracksList").innerHTML = tracksData.map(renderTrack).join('');
        attachHandlers();
      }

      function attachHandlers() {
        document.querySelectorAll('.play-btn').forEach(btn => {
          btn.onclick = () => {
            const url = btn.dataset.preview;
            const idx = btn.dataset.idx;
            if (btn.classList.contains('playing')) { if (currentAudio) currentAudio.pause(); clearActiveTrack(); }
            else { clearActiveTrack(); playPreview(url, btn, idx); }
          };
        });
        document.querySelectorAll('.visualize-btn').forEach(btn => {
          if (btn.dataset.vizUrl) {
            btn.onclick = () => window.openVisualizer(btn.dataset.vizUrl, btn.dataset.vizName || '', btn.dataset.vizArtist || '');
          }
        });
        document.querySelectorAll('.features-toggle').forEach(tog => {
          tog.onclick = () => {
            const el = $('feats-' + tog.dataset.idx);
            if (el) { el.classList.toggle('open'); tog.textContent = el.classList.contains('open') ? '‚ñæ Raw audio features' : '‚ñ∏ Raw audio features'; }
          };
        });
      }

      // ‚îÄ‚îÄ Load playlist (Deezer previews only, fast) ‚îÄ‚îÄ
      $("fetchBtn").onclick = async () => {
        const link = $("playlistLink").value.trim();
        if (!link) { setStatus("‚ùå Paste a YouTube Music playlist link"); return; }
        playlistId = extractPlaylistId(link);
        if (!playlistId) { setStatus("‚ùå Invalid playlist link"); return; }

        try {
          setStatus("‚è≥ Fetching playlist & matching Deezer previews‚Ä¶");
          setProgress(null);
          $("generateBtn").disabled = true;
          cachedPlaylistSummary = null;  // reset cache for new playlist

          // Remove any previous generated song card
          const prevCard = document.querySelector('.generated-song-card');
          if (prevCard) prevCard.remove();

          const resp = await fetch(`/api/playlist/${playlistId}/deezer-previews`);
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);
          const data = await resp.json();

          // Check if we have playlist image from the more detailed endpoint
          let playlistImageUrl = null;
          try {
            const detailResp = await fetch(`/api/playlist/${playlistId}`);
            if (detailResp.ok) {
              const detailData = await detailResp.json();
              playlistImageUrl = detailData.image;
            }
          } catch (e) { /* ignore */ }

          const imageHTML = playlistImageUrl 
            ? `<img src="${playlistImageUrl}" alt="Playlist cover" class="playlist-image" />`
            : '';
          
          $("playlistInfo").innerHTML = `
            <div class="playlist-info-container">
              ${imageHTML}
              <div class="playlist-details">
                <div class="playlist-title">${data.playlist.name}</div>
                <div class="playlist-meta">${data.playlist.totalTracks} tracks</div>
              </div>
            </div>
          `;

          tracksData = data.tracks.map(t => ({
            name: t.name,
            artist: t.artists,
            duration: t.duration,
            thumbnail: t.thumbnail,
            deezer: t.deezer,
            audio_features: null,
            tags: null,
            description: null,
          }));

          renderAllTracks();
          $("generateBtn").disabled = false;
          setStatus(`‚úÖ Loaded ${tracksData.length} tracks. Hit <b>Generate Song</b> to analyze & create music.`);
        } catch (e) {
          setStatus(`‚ùå ${e.message}`);
        }
      };

      // ‚îÄ‚îÄ Analyze all tracks (calls Flask backend) ‚îÄ‚îÄ
      async function analyzePlaylist() {
        if (!playlistId || tracksData.length === 0) return false;

        setStatus("üß† Analyzing audio features and generating style profile‚Ä¶", 'status-analyzing');
        startSimulatedProgress(60000);

        try {
          const resp = await fetch(`/api/playlist/${playlistId}/analysis`);
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);

          stopSimulatedProgress();
          const data = await resp.json();

          // Merge analysis into our store (keep data internally, hidden from UI)
          tracksData = data.tracks.map(t => ({
            name: t.name,
            artist: t.artist,
            duration: t.duration,
            deezer: t.deezer,
            thumbnail: t.thumbnail,
            audio_features: t.audio_features,
            tags: t.tags,
            description: t.description,
          }));

          renderAllTracks();

          // Cache GPT-4 playlist summary for generation (not displayed)
          cachedPlaylistSummary = data.playlist_summary || null;
          return true;
        } catch (e) {
          setStatus(`‚ùå Analysis failed: ${e.message}`, 'status-error');
          stopSimulatedProgress();
          setProgress(null);
          return false;
        }
      }

      // ‚îÄ‚îÄ Generate song (analyze first if needed, then call DiffRhythm) ‚îÄ‚îÄ
      $("generateBtn").onclick = async () => {
        if (!playlistId || tracksData.length === 0) return;
        const withLyrics = !$("instrumentalCheckbox").checked;

        $("generateBtn").disabled = true;
        $("generateBtn").textContent = '‚è≥ Working‚Ä¶';

        // Step 1: Analyze if not cached
        if (!cachedPlaylistSummary) {
          setStatus('üß† Analyzing playlist audio features‚Ä¶', 'status-analyzing');
          const ok = await analyzePlaylist();
          if (!ok || !cachedPlaylistSummary) {
            $("generateBtn").disabled = false;
            $("generateBtn").textContent = 'üé∂ Generate Song';
            return;
          }
        }

        // Step 2: Generate with DiffRhythm
        $("generateBtn").textContent = withLyrics ? 'üé§ Generating with vocals‚Ä¶' : 'üé∂ Generating‚Ä¶';
        setStatus(withLyrics
          ? 'üé§ Writing lyrics & generating song‚Ä¶ This may take 2-4 minutes.'
          : 'üéµ Generating song‚Ä¶ This may take 2-4 minutes.', 'status-analyzing');
        startSimulatedProgress(180000);

        // Remove any previous generated song card
        const prev = document.querySelector('.generated-song-card');
        if (prev) prev.remove();

        try {
          const resp = await fetch('/api/diffrhythm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: cachedPlaylistSummary,
              options: { steps: 50, file_type: 'mp3', withLyrics }
            })
          });
          stopSimulatedProgress();
          if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.status);
          const result = await resp.json();
          setProgress(100);

          if (result.url) {
            const lyricsBlock = result.lyrics_used && result.lyrics_used !== '[00:00.00] Instrumental'
              ? `<details style="margin-bottom:12px;"><summary style="cursor:pointer;color:var(--accent);font-size:13px;">üé§ Generated Lyrics</summary><pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;font-size:12px;line-height:1.6;margin-top:8px;white-space:pre-wrap;color:var(--text);">${result.lyrics_used}</pre></details>`
              : '';
            const genAudioUrl = result.url;
            const card = document.createElement('div');
            card.className = 'generated-song-card card';
            card.innerHTML = `
              <h3>üé∂ Generated Song ${withLyrics ? '(with vocals)' : '(instrumental)'}</h3>
              <p style="font-size: 14px; opacity: 0.8; margin: 0 0 12px 0;">Based on the audio analysis of your playlist</p>
              ${lyricsBlock}
              <audio controls src="${genAudioUrl}"></audio>
              <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <a href="${genAudioUrl}" download style="color:#a78bfa;font-size:13px;">‚¨á Download</a>
                <button class="visualize-btn" data-viz-url="${genAudioUrl}" data-viz-name="Generated Song" data-viz-artist="MusicGen AI">üîÆ Visualize</button>
              </div>
            `;
            const playlistInfo = $('playlistInfo');
            playlistInfo.parentNode.insertBefore(card, playlistInfo.nextSibling);
            // Attach visualize handler for the new card
            card.querySelector('.visualize-btn').onclick = function() {
              window.openVisualizer(this.dataset.vizUrl, this.dataset.vizName, this.dataset.vizArtist);
            };
            setStatus('‚úÖ Song generated successfully!', 'status-done');
          } else {
            setStatus('‚ö†Ô∏è Song generated but no audio URL returned.', 'status-error');
          }
          setTimeout(() => setProgress(null), 2000);
        } catch (e) {
          setStatus(`‚ùå Song generation failed: ${e.message}`, 'status-error');
          stopSimulatedProgress();
          setProgress(null);
        } finally {
          $("generateBtn").disabled = false;
          $("generateBtn").textContent = 'üé∂ Generate Song';
        }
      };

      $("playlistLink").addEventListener("keypress", e => { if (e.key === "Enter") $("fetchBtn").click(); });

      // ‚îÄ‚îÄ Inline Visualizer (wireframe sphere + simplex noise + color cycling) ‚îÄ‚îÄ
      let vizActive = false;
      let vizRenderer = null, vizScene = null, vizCamera = null;
      let vizAnalyser = null, vizAudioCtx = null;
      let vizDataArray = null;
      let vizSphere = null, vizOrigPos = null;
      let vizAudioEl = null;
      let vizAnimId = null;
      let vizNoise = null;

      function vizAvg(arr) {
        var total = 0; for (var i = 0; i < arr.length; i++) total += arr[i];
        return total / arr.length;
      }
      function vizMax(arr) {
        var m = 0; for (var i = 0; i < arr.length; i++) if (arr[i] > m) m = arr[i];
        return m;
      }
      function vizModulate(val, minV, maxV, outMin, outMax) {
        var fr = (val - minV) / (maxV - minV);
        return outMin + fr * (outMax - outMin);
      }

      var VIZ_RADIUS = 20;

      function vizWarpSphere(mesh, normDir, noise, bassFr, treFr) {
        var pos = mesh.geometry.attributes.position;
        var time = performance.now();
        var amp = 5;
        var rf = 0.00001;
        for (var i = 0; i < pos.count; i++) {
          var nx = normDir[i * 3], ny = normDir[i * 3 + 1], nz = normDir[i * 3 + 2];
          var n = noise.noise3D(
            nx + time * rf * 4,
            ny + time * rf * 6,
            nz + time * rf * 7
          );
          var distance = Math.max(1, (VIZ_RADIUS + bassFr) + n * amp * treFr * 2);
          pos.setXYZ(i, nx * distance, ny * distance, nz * distance);
        }
        pos.needsUpdate = true;
        mesh.geometry.computeVertexNormals();
      }

      // ‚îÄ‚îÄ Custom player helpers ‚îÄ‚îÄ
      function vizFmtTime(s) {
        if (!s || !isFinite(s)) return '0:00';
        var m = Math.floor(s / 60), sec = Math.floor(s % 60);
        return m + ':' + (sec < 10 ? '0' : '') + sec;
      }
      function vizSetupPlayer() {
        var audio = $('vizAudio');
        var playBtn = $('vizPlayBtn');
        var progressBar = $('vizProgressBar');
        var progressFill = $('vizProgressFill');
        var timeCur = $('vizTimeCur');
        var timeDur = $('vizTimeDur');
        var volSlider = $('vizVolSlider');
        var volIcon = $('vizVolIcon');

        playBtn.onclick = function() {
          if (vizAudioCtx && vizAudioCtx.state === 'suspended') vizAudioCtx.resume();
          if (audio.paused) { audio.play().catch(function(){}); }
          else { audio.pause(); }
        };
        audio.onplay = function() { playBtn.textContent = '‚è∏'; };
        audio.onpause = function() { playBtn.textContent = '‚ñ∂'; };
        audio.ontimeupdate = function() {
          timeCur.textContent = vizFmtTime(audio.currentTime);
          if (audio.duration) {
            progressFill.style.width = (audio.currentTime / audio.duration * 100) + '%';
          }
        };
        audio.onloadedmetadata = function() {
          timeDur.textContent = vizFmtTime(audio.duration);
        };
        progressBar.onclick = function(e) {
          if (audio.duration) {
            var rect = progressBar.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
          }
        };
        var volPct = $('vizVolPct');
        volSlider.oninput = function() {
          audio.volume = parseFloat(volSlider.value);
          volPct.textContent = Math.round(audio.volume * 100) + '%';
          volIcon.textContent = audio.volume === 0 ? 'üîá' : audio.volume < 0.5 ? 'üîâ' : 'üîä';
        };
        volIcon.onclick = function() {
          if (audio.volume > 0) { audio._prevVol = audio.volume; audio.volume = 0; volSlider.value = 0; volIcon.textContent = 'üîá'; }
          else { audio.volume = audio._prevVol || 1; volSlider.value = audio.volume; volIcon.textContent = 'üîä'; }
          volPct.textContent = Math.round(audio.volume * 100) + '%';
        };
      }
      var vizPlayerReady = false;

      window.openVisualizer = function(audioUrl, name, artist) {
        if (currentAudio) { currentAudio.pause(); clearActiveTrack(); }

        var overlay = $('vizOverlay');
        overlay.classList.add('active');
        vizActive = true;
        document.body.style.overflow = 'hidden';

        $('vizSongName').textContent = name || 'Unknown Song';
        $('vizSongArtist').textContent = artist || '';

        vizAudioEl = $('vizAudio');
        vizAudioEl.src = audioUrl;
        $('vizPlayBtn').textContent = '‚ñ∂';
        $('vizProgressFill').style.width = '0%';
        $('vizTimeCur').textContent = '0:00';
        $('vizTimeDur').textContent = '0:00';

        if (!vizPlayerReady) { vizSetupPlayer(); vizPlayerReady = true; }

        // Ensure AudioContext + source
        if (!vizAudioCtx) {
          vizAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
          vizAnalyser = vizAudioCtx.createAnalyser();
          vizAnalyser.fftSize = 512;
          vizDataArray = new Uint8Array(vizAnalyser.frequencyBinCount);
          var src = vizAudioCtx.createMediaElementSource(vizAudioEl);
          src.connect(vizAnalyser);
          vizAnalyser.connect(vizAudioCtx.destination);
        }
        if (vizAudioCtx.state === 'suspended') vizAudioCtx.resume();

        var canvas = $('vizCanvas');
        if (!vizRenderer) {
          vizNoise = new SimplexNoise();

          vizScene = new THREE.Scene();
          vizCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
          vizCamera.position.z = 100;
          vizScene.add(vizCamera);

          vizRenderer = new THREE.WebGLRenderer({ antialias: true, canvas: canvas });
          vizRenderer.setPixelRatio(Math.min(devicePixelRatio, 2));
          vizRenderer.setClearColor('#000000');

          var geometry = new THREE.SphereGeometry(VIZ_RADIUS, 256, 128);
          var material = new THREE.MeshLambertMaterial({ color: new THREE.Color(1,1,1), wireframe: true });
          vizSphere = new THREE.Mesh(geometry, material);

          var posAttr = geometry.attributes.position;
          vizOrigPos = new Float32Array(posAttr.count * 3);
          for (var i = 0; i < posAttr.count; i++) {
            var x = posAttr.getX(i), y = posAttr.getY(i), z = posAttr.getZ(i);
            var len = Math.sqrt(x * x + y * y + z * z);
            if (len < 0.001) len = 0.001;
            vizOrigPos[i * 3]     = x / len;
            vizOrigPos[i * 3 + 1] = y / len;
            vizOrigPos[i * 3 + 2] = z / len;
          }

          var light = new THREE.DirectionalLight('#ffffff', 3);
          light.position.set(0, 50, 100);
          vizScene.add(light);
          vizScene.add(vizSphere);
        }

        vizRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
        vizCamera.aspect = canvas.clientWidth / canvas.clientHeight;
        vizCamera.updateProjectionMatrix();

        function vizAnimate() {
          if (!vizActive) return;
          vizAnimId = requestAnimationFrame(vizAnimate);

          vizAnalyser.getByteFrequencyData(vizDataArray);

          var half = Math.floor(vizDataArray.length / 2);
          var lowerHalf = vizDataArray.slice(0, half);
          var upperHalf = vizDataArray.slice(half);

          var lowerMax = vizMax(lowerHalf);
          var upperAvg = vizAvg(upperHalf);
          var overallAvg = vizAvg(vizDataArray);

          var lowerMaxFr = lowerMax / lowerHalf.length;
          var upperAvgFr = upperAvg / upperHalf.length;
          var overallFr = overallAvg / 255;

          // ‚îÄ‚îÄ Smooth color transitions with white dips ‚îÄ‚îÄ
          var t = performance.now() * 0.0001;
          // Slow sinusoidal hue drift through pleasing ranges
          var h1 = (Math.sin(t * 0.7) * 0.5 + 0.5);        // 0-1
          var h2 = (Math.sin(t * 1.1 + 2.0) * 0.5 + 0.5);
          var hue = (h1 * 0.6 + h2 * 0.4);                  // blended hue
          // Bass nudges hue forward gently
          hue = (hue + overallFr * 0.08) % 1.0;
          // Saturation dips toward white on strong treble peaks
          var whiteDip = Math.pow(upperAvgFr, 2.5) * 1.5;   // much gentler curve
          var sat = Math.max(0.15, 0.65 - whiteDip * 0.35);  // floors at 0.15, not 0
          var lit = 0.5 + overallFr * 0.15 + whiteDip * 0.15; // subtler brightness bump
          lit = Math.min(lit, 0.95);
          vizSphere.material.color.setHSL(hue, sat, lit);

          // ‚îÄ‚îÄ Original rotation (constant) ‚îÄ‚îÄ
          vizSphere.rotation.x += 0.001;
          vizSphere.rotation.y += 0.003;
          vizSphere.rotation.z += 0.005;

          vizWarpSphere(
            vizSphere, vizOrigPos, vizNoise,
            vizModulate(Math.pow(lowerMaxFr, 0.8), 0, 1, 0, 8),
            vizModulate(upperAvgFr, 0, 1, 0, 4)
          );

          // ‚îÄ‚îÄ Subtle background color pulse ‚îÄ‚îÄ
          var bgL = overallFr * 0.04;
          vizRenderer.setClearColor(new THREE.Color().setHSL(hue, 0.4, bgL));
          vizRenderer.render(vizScene, vizCamera);
        }
        vizAnimate();
        vizAudioEl.play().catch(function(){});
      };

      window.closeVisualizer = function() {
        vizActive = false;
        if (vizAnimId) cancelAnimationFrame(vizAnimId);
        if (vizAudioEl) { vizAudioEl.pause(); vizAudioEl.src = ''; }
        $('vizOverlay').classList.remove('active');
        document.body.style.overflow = '';
      };

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && vizActive) window.closeVisualizer();
        // Space bar toggles play/pause inside visualizer
        if (e.key === ' ' && vizActive) {
          e.preventDefault();
          if (vizAudioEl.paused) vizAudioEl.play().catch(function(){});
          else vizAudioEl.pause();
        }
      });

      window.addEventListener('resize', function() {
        if (vizActive && vizRenderer) {
          var c = $('vizCanvas');
          vizRenderer.setSize(c.clientWidth, c.clientHeight);
          vizCamera.aspect = c.clientWidth / c.clientHeight;
          vizCamera.updateProjectionMatrix();
        }
      });
    </script>
    </div>

    <!-- Fullscreen visualizer overlay -->
    <div id="vizOverlay">
      <canvas id="vizCanvas" style="width:100%;height:100%;"></canvas>
      <audio id="vizAudio" crossorigin="anonymous" preload="auto"></audio>
      <div class="viz-top-bar">
        <div class="viz-song-info">
          <div class="viz-song-name" id="vizSongName">‚Äî</div>
          <div class="viz-song-artist" id="vizSongArtist">‚Äî</div>
        </div>
        <button class="viz-close-btn" onclick="window.closeVisualizer()">‚úï Close</button>
      </div>
      <div class="viz-bottom-bar">
        <div class="viz-player">
          <div class="viz-player-row">
            <button class="viz-play-btn" id="vizPlayBtn">‚ñ∂</button>
            <div class="viz-progress-wrap">
              <div class="viz-progress-bar" id="vizProgressBar">
                <div class="viz-progress-fill" id="vizProgressFill"></div>
              </div>
              <div class="viz-time-row">
                <span id="vizTimeCur">0:00</span>
                <span id="vizTimeDur">0:00</span>
              </div>
            </div>
            <div class="viz-vol-wrap" id="vizVolWrap">
              <div class="viz-vol-popup">
                <span class="viz-vol-pct" id="vizVolPct">100%</span>
                <input type="range" class="viz-vol-slider" id="vizVolSlider" min="0" max="1" step="0.01" value="1">
              </div>
              <span class="viz-vol-icon" id="vizVolIcon">üîä</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
